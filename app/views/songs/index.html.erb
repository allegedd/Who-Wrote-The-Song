<div class="min-h-screen bg-gray-950 pt-8">
  <div class="container mx-auto px-4">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-100 mb-4">æ¤œç´¢çµæœ</h1>
      
      <% if params[:title].present? %>
        <p class="text-gray-400">
          ã€Œ<span class="text-gray-200 font-medium"><%= params[:title] %></span>ã€
          <% if params[:artist].present? %>
            ï¼ˆã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ: <span class="text-gray-200 font-medium"><%= params[:artist] %></span>ï¼‰
          <% end %>
          ã®æ¤œç´¢çµæœ
        </p>
      <% end %>
    </div>

    <!-- æ¤œç´¢çµæœã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="search-results-container">
      <% if @songs.present? %>
        <div class="grid gap-4" id="songs-grid">
          <% @songs.each_with_index do |song, index| %>
            <div class="bg-gray-900 rounded-lg p-6 border border-gray-800 hover:border-gray-700 transition-colors song-item" 
                 style="animation-delay: <%= index * 50 %>ms">
              <div class="flex justify-between items-start">
                <%= link_to song_path(song.id), class: "block flex-1" do %>
                  <div>
                    <h2 class="text-xl font-semibold text-gray-100 mb-2">
                      <%= song.title %>
                    </h2>
                    <p class="text-gray-400 mb-2" data-artist-info="<%= song.id %>">
                      ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ: <span class="text-gray-300 artist-name">
                        <%= song.artist.present? ? song.artist : "èª­ã¿è¾¼ã¿ä¸­..." %>
                      </span>
                      <% if song.loading_artist || song.artist.blank? %>
                        <span class="artist-loading text-gray-500 text-sm ml-2">ğŸ”„</span>
                      <% end %>
                    </p>
                    <% if song.creator_names.present? %>
                      <p class="text-sm text-gray-400 mt-2">
                        <%= song.creator_names %>
                      </p>
                    <% else %>
                      <p class="text-sm text-gray-500 mt-2">
                        â€»ä½œè©ä½œæ›²æƒ…å ±ãªã—
                      </p>
                    <% end %>
                  </div>
                <% end %>
                
                <div class="flex items-center ml-4">
                  <%= link_to song_path(song.id), class: "text-green-500 hover:text-green-400" do %>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
        
        <!-- æ¤œç´¢çµæœãŒä¸Šé™ã«é”ã—ã¦ã„ã‚‹å ´åˆã®èª˜å° -->
        <% if @songs.present? && @songs.size >= 10 && params[:artist].blank? %>
          <div class="bg-gray-800 rounded-lg p-6 mt-6 border border-gray-700">
            <h3 class="text-lg font-medium text-gray-100 mb-3">ğŸ” ãŠæ¢ã—ã®æ¥½æ›²ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ</h3>
            <p class="text-gray-300 mb-4">
              åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã®æ¥½æ›²ãŒå¤šæ•°ã‚ã‚‹ãŸã‚ã€10ä»¶ã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br>
              <span class="text-green-400">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’è¿½åŠ </span>ã™ã‚‹ã“ã¨ã§ã€ãŠæ¢ã—ã®æ¥½æ›²ã‚’è¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚
            </p>
            <form method="GET" action="<%= songs_path %>" class="flex gap-3">
              <input type="hidden" name="title" value="<%= params[:title] %>">
              <input type="text" name="artist" placeholder="ä¾‹: YOASOBIã€ç±³æ´¥ç„å¸«ã€Officialé«­ç”·dism" 
                     class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
              <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors">
                çµã‚Šè¾¼ã¿æ¤œç´¢
              </button>
            </form>
          </div>
        <% end %>
      <% else %>
        <div class="bg-gray-900 rounded-lg p-8 text-center border border-gray-800">
          <p class="text-gray-400 mb-4">
            <% if params[:title].present? %>
              è©²å½“ã™ã‚‹æ¥½æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
            <% else %>
              æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            <% end %>
          </p>
          <%= link_to "æ¤œç´¢ç”»é¢ã«æˆ»ã‚‹", root_path, class: "text-green-500 hover:text-green-400 font-medium" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .song-item {
    opacity: 0;
    animation: fadeInUp 0.4s ease-out forwards;
  }
  
  /* ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .artist-loading {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  /* ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±æ›´æ–°æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .artist-name-updated {
    animation: highlightUpdate 1s ease-out;
  }
  
  @keyframes highlightUpdate {
    0% { background-color: rgba(34, 197, 94, 0.2); }
    100% { background-color: transparent; }
  }
</style>

<script>
  console.log('=== Script Start ===');
  console.log('Script loaded in search results page');
  console.log('Document ready state:', document.readyState);
  console.log('===================');
  
  // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±ã®éåŒæœŸèª­ã¿è¾¼ã¿
  function loadArtistsOnSearchPage() {
    console.log('loadArtistsOnSearchPage called');
    
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼ˆDOMã®å®Œå…¨ãªæ§‹ç¯‰ã‚’å¾…ã¤ï¼‰
    setTimeout(function() {
      const artistElements = document.querySelectorAll('[data-artist-info]');
      console.log(`Found ${artistElements.length} artist elements`);
      
      const loadingArtists = Array.from(artistElements).filter(el => 
        el.querySelector('.artist-loading')
      );
      console.log(`Found ${loadingArtists.length} elements with loading artists`);
      
      if (loadingArtists.length > 0) {
        // èª­ã¿è¾¼ã¿ä¸­ã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±ã®IDã‚’åé›†
        const songIds = loadingArtists.map(el => el.dataset.artistInfo);
        console.log('Loading artists for IDs:', songIds);
        
        // éåŒæœŸã§ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
        fetch(`/songs/load_artists?song_ids=${songIds.join(',')}`, {
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      })
      .then(response => response.json())
      .then(data => {
        // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±ã‚’æ›´æ–°
        data.artists.forEach(artist => {
          const element = document.querySelector(`[data-artist-info="${artist.id}"]`);
          if (element) {
            const nameSpan = element.querySelector('.artist-name');
            const loadingSpan = element.querySelector('.artist-loading');
            
            if (nameSpan) {
              nameSpan.textContent = artist.artist;
              // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
              nameSpan.classList.add('artist-name-updated');
              setTimeout(() => {
                nameSpan.classList.remove('artist-name-updated');
              }, 1000);
            }
            if (loadingSpan) {
              loadingSpan.remove();
            }
          }
        });
      })
      .catch(error => {
        console.error('ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯èª­ã¿è¾¼ã¿ä¸­ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
        loadingArtists.forEach(el => {
          const loadingSpan = el.querySelector('.artist-loading');
          if (loadingSpan) {
            loadingSpan.remove();
          }
        });
      });
      }
    }, 50); // 0.05ç§’ã«çŸ­ç¸®ã—ã¦é«˜é€ŸåŒ–
  }
  
  // Turboå¯¾å¿œã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.addEventListener('DOMContentLoaded', loadArtistsOnSearchPage);
  document.addEventListener('turbo:load', loadArtistsOnSearchPage);
  document.addEventListener('turbo:render', loadArtistsOnSearchPage);
  
  // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
  if (document.readyState === 'loading') {
    console.log('Document is loading');
  } else {
    console.log('Document already loaded, executing immediately');
    loadArtistsOnSearchPage();
  }
</script>